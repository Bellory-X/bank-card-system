openapi: 3.0.1
info:
  title: User Management API
  description: API for managing users with user and admin endpoints
  version: 1.0.0

servers:
  - url: http://localhost:8080/api
    description: Local server

tags:
  - name: profile
    description: Endpoints for regular users (profile management)
  - name: admin-users
    description: Endpoints for administrators (user management)

paths:
  # ==================== USER PROFILE ENDPOINTS ====================
  /profile:
    get:
      tags:
        - profile
      summary: Get current user profile
      description: Returns profile information of authenticated user
      operationId: getCurrentUserProfile
      responses:
        '200':
          description: Successfully retrieved profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

    put:
      tags:
        - profile
      summary: Update current user profile
      description: Updates profile information of authenticated user
      operationId: updateCurrentUserProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

  /profile/password:
    put:
      tags:
        - profile
      summary: Change password
      description: Changes password for authenticated user
      operationId: changePassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
      responses:
        '204':
          description: Password changed successfully
        '400':
          description: Invalid current password or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

  # ==================== ADMIN USER MANAGEMENT ENDPOINTS ====================
  /admin/users:
    get:
      tags:
        - admin-users
      summary: Get all users
      description: Returns paginated list of all users (admin only)
      operationId: getAllUsers
      parameters:
        - name: page
          in: query
          description: Page number (zero-based)
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: size
          in: query
          description: Page size
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: sortBy
          in: query
          description: Field to sort by
          schema:
            $ref: '#/components/schemas/UserSortField'
        - name: sortDirection
          in: query
          description: Sort direction
          schema:
            $ref: '#/components/schemas/SortDirection'
        - name: role
          in: query
          description: Filter by user role
          schema:
            $ref: '#/components/schemas/UserRole'
        - name: enabled
          in: query
          description: Filter by enabled status
          schema:
            type: boolean
        - name: searchQuery
          in: query
          description: Search by login or full name (partial match)
          schema:
            type: string
            minLength: 2
      responses:
        '200':
          description: Successfully retrieved users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPageable'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

    post:
      tags:
        - admin-users
      summary: Create new user
      description: Creates a new user (admin only). Admin can create both USER and ADMIN roles
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: User with this login already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

  /admin/users/{userId}:
    get:
      tags:
        - admin-users
      summary: Get user by ID
      description: Returns detailed user information (admin only)
      operationId: getUserById
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successfully retrieved user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

    put:
      tags:
        - admin-users
      summary: Update user
      description: Updates user information (admin only)
      operationId: updateUser
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

    delete:
      tags:
        - admin-users
      summary: Delete user
      description: Permanently deletes a user (admin only)
      operationId: deleteUser
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: User deleted successfully
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

  /admin/users/{userId}/role:
    patch:
      tags:
        - admin-users
      summary: Update user role
      description: Updates role for a user (admin only). Admin can set any role including ADMIN
      operationId: updateUserRole
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - role
              properties:
                role:
                  $ref: '#/components/schemas/UserRole'
      responses:
        '200':
          description: Role updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Invalid role assignment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

  /admin/users/{userId}/status:
    patch:
      tags:
        - admin-users
      summary: Toggle user status
      description: Enable or disable user account (admin only)
      operationId: toggleUserStatus
      parameters:
        - name: userId
          in: path
          required: true
          description: User ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - enabled
              properties:
                enabled:
                  type: boolean
                  description: New enabled status
      responses:
        '204':
          description: Status updated successfully
        '400':
          description: Cannot disable own account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      security:
        - bearerAuth: []

components:
  schemas:
    # ==================== ENUMS ====================
    UserRole:
      type: string
      description: User role (single role per user)
      enum:
        - ADMIN
        - USER
      example: USER

    UserSortField:
      type: string
      description: Fields available for sorting users
      enum:
        - LOGIN
        - FULL_NAME
        - ROLE
        - CREATED_AT
        - ENABLED
      example: CREATED_AT

    SortDirection:
      type: string
      description: Sort direction
      enum:
        - ASC
        - DESC
      default: DESC
      example: DESC

    # ==================== REQUEST DTOs ====================
    UpdateProfileRequest:
      type: object
      description: Request body for updating user profile
      properties:
        fullName:
          type: string
          description: User's full name
          minLength: 2
          maxLength: 100
          example: "Ivan Petrov"
        email:
          type: string
          format: email
          description: User's email address
          example: "ivan@example.com"
        phone:
          type: string
          description: User's phone number
          example: "+1234567890"

    ChangePasswordRequest:
      type: object
      description: Request body for changing password
      required:
        - currentPassword
        - newPassword
        - confirmPassword
      properties:
        currentPassword:
          type: string
          format: password
          description: Current password
          minLength: 8
          example: "oldPassword123"
        newPassword:
          type: string
          format: password
          description: New password
          minLength: 8
          pattern: "^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%^&+=]).*$"
          example: "NewPass123!"
        confirmPassword:
          type: string
          format: password
          description: Confirm new password
          example: "NewPass123!"

    CreateUserRequest:
      type: object
      description: Request body for creating a new user (admin)
      required:
        - login
        - password
        - fullName
        - role
      properties:
        login:
          type: string
          description: User login (email)
          minLength: 3
          maxLength: 50
          pattern: "^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,6}$"
          example: "user@example.com"
        password:
          type: string
          format: password
          description: User password
          minLength: 8
          example: "securePassword123"
        fullName:
          type: string
          description: User's full name
          minLength: 2
          maxLength: 100
          example: "Ivan Petrov"
        role:
          $ref: '#/components/schemas/UserRole'
          description: User role (ADMIN or USER)
        enabled:
          type: boolean
          description: User enabled status
          default: true

    UpdateUserRequest:
      type: object
      description: Request body for updating user (admin)
      properties:
        fullName:
          type: string
          description: User's full name
          minLength: 2
          maxLength: 100
          example: "Ivan Petrov"
        enabled:
          type: boolean
          description: User enabled status
          example: true

    # ==================== RESPONSE DTOs (USER PROFILE) ====================
    ProfileResponse:
      type: object
      description: User profile information (visible to the user)
      properties:
        id:
          type: string
          format: uuid
          description: User ID
          example: "123e4567-e89b-12d3-a456-426614174000"
        login:
          type: string
          description: User login
          example: "user@example.com"
        fullName:
          type: string
          description: User's full name
          example: "Ivan Petrov"
        email:
          type: string
          description: User's email
          example: "ivan@example.com"
        phone:
          type: string
          description: User's phone number
          example: "+1234567890"
        role:
          $ref: '#/components/schemas/UserRole'
          description: User role
        enabled:
          type: boolean
          description: Account enabled status
          example: true
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
          example: "2024-01-15T10:30:00Z"

    # ==================== RESPONSE DTOs (ADMIN USER VIEW) ====================
    UserResponse:
      type: object
      description: User information visible to administrators
      properties:
        id:
          type: string
          format: uuid
          description: User ID
          example: "123e4567-e89b-12d3-a456-426614174000"
        login:
          type: string
          description: User login
          example: "user@example.com"
        fullName:
          type: string
          description: User's full name
          example: "Ivan Petrov"
        email:
          type: string
          description: User's email
          example: "ivan@example.com"
        phone:
          type: string
          description: User's phone number
          example: "+1234567890"
        role:
          $ref: '#/components/schemas/UserRole'
          description: User role
        enabled:
          type: boolean
          description: Account enabled status
          example: true
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
          example: "2024-01-15T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
          example: "2024-01-20T14:25:00Z"
        lastLoginAt:
          type: string
          format: date-time
          description: Last login timestamp
          example: "2024-01-25T09:15:00Z"
        cardsCount:
          type: integer
          description: Number of cards owned by user
          example: 3

    UserPageable:
      type: object
      description: Paginated response with users (admin view)
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/UserResponse'
        page:
          type: integer
          description: Current page number
          example: 0
        size:
          type: integer
          description: Page size
          example: 20
        totalElements:
          type: integer
          format: int64
          description: Total number of users
          example: 45
        totalPages:
          type: integer
          description: Total number of pages
          example: 3
        first:
          type: boolean
          description: Whether this is the first page
          example: true
        last:
          type: boolean
          description: Whether this is the last page
          example: false

    # ==================== ERROR RESPONSE ====================
    ErrorResponse:
      type: object
      description: Standard error response
      properties:
        code:
          type: string
          description: Error code (e.g., USER_NOT_FOUND, DUPLICATE_LOGIN)
          example: "USER_NOT_FOUND"
        message:
          type: string
          description: Human-readable error message
          example: "User with ID 123e4567-e89b-12d3-a456-426614174999 not found"
        timestamp:
          type: string
          format: date-time
          description: Error timestamp
          example: "2024-01-25T15:30:00Z"
        path:
          type: string
          description: Request path that caused the error
          example: "/api/admin/users/123e4567-e89b-12d3-a456-426614174999"
        details:
          type: object
          description: Additional error details
          additionalProperties: true
          example:
            userId: "123e4567-e89b-12d3-a456-426614174999"
            field: "login"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Enter JWT token

security:
  - bearerAuth: []